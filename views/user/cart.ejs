<%- include('../layout/usertem.ejs') %>
    <%- include ("../layout/cdn")%>

        <style>
            .cart-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            .cart-header {
                text-align: center;
                margin-bottom: 40px;
            }

            .cart-header h1 {
                font-size: 2rem;
                color: #333;
                margin-bottom: 10px;
            }

            .empty-cart {
                text-align: center;
                padding: 60px 20px;
                background: #f9fafb;
                border-radius: 8px;
                margin: 20px 0;
            }

            .empty-cart i {
                font-size: 48px;
                color: #9ca3af;
                margin-bottom: 20px;
            }

            .empty-cart h3 {
                font-size: 1.5rem;
                color: #374151;
                margin-bottom: 10px;
            }

            .empty-cart p {
                color: #6b7280;
                margin-bottom: 20px;
            }

            .shopping-summery {
                background: white;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .shopping-summery thead {
                background: #f3f4f6;
            }

            .shopping-summery th {
                padding: 15px;
                font-weight: 600;
                color: #374151;
            }

            .shopping-summery td {
                padding: 15px;
                vertical-align: middle;
            }


            .cart-product-quantity input {
                -moz-appearance: textfield;
                width: 50px !important;
                padding: 0 !important;
                text-align: center;
            }

            .cart-totals {
                background: white;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .btn {
                background: #3366cc;
                color: white;
                padding: 12px 24px;
                border-radius: 6px;
                border: none;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .btn:hover {
                background: #2952a3;
            }

            .product-thumbnail img {
                width: 80px;
                height: 80px;
                object-fit: cover;
                border-radius: 4px;
            }

            .remove-btn {
                background: none;
                border: none;
                color: #ef4444;
                cursor: pointer;
                transition: color 0.2s;
            }

            .remove-btn:hover {
                color: #dc2626;
            }

            .cart-product-quantity {
                display: inline-flex;
                align-items: center;
                gap: 5px;
                border-radius: 8px;
                padding: 5px;
            }

            .cart-product-quantity .form-control {
                width: 60px;
                height: 40px;
                text-align: center;
                font-size: 16px;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                -moz-appearance: textfield;
                margin: 0 5px;
            }

            .quantity-btn {
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 1px solid #e5e7eb;
                background-color: #f9fafb;
                color: #374151;
                font-size: 20px;
                cursor: pointer;
                border-radius: 6px;
                transition: all 0.2s;
            }

            .quantity-btn:hover {
                background-color: #e5e7eb;
            }

            .quantity-btn:active {
                transform: scale(0.95);
            }

            /* Remove default spinner buttons */
            .cart-product-quantity input::-webkit-outer-spin-button,
            .cart-product-quantity input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            .cart-action {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 20px 0;
            }

            .clear-cart-btn {
                background-color: #dc2626;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .clear-cart-btn:hover {
                background-color: #b91c1c;
            }

            .clear-cart-btn i {
                font-size: 16px;
            }
        </style>


        <main class="main">
            <header class="header_section" style="color: grey;">

                <div class="container-fluid">
                    <nav class="navbar navbar-expand-lg custom_nav-container ">
                        <a class="navbar-brand" href="/jewellery">
                            <img src="images/logo.png" style="width: 350px;" alt="">
                            <span>

                            </span>
                        </a>
                        <button class="navbar-toggler" type="button" data-toggle="collapse"
                            data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                            aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>

                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <div class="d-flex ml-auto flex-column flex-lg-row align-items-center">
                                <ul class="navbar-nav  ">
                                    <li class="nav-item active">
                                        <a class="nav-link" href="/home" style="color: black;font-size: medium;">Home
                                            <span class="sr-only">(current)</span></a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/about" style="color: black;font-size: medium;">
                                            About</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/jewellery"
                                            style="color: black;font-size: medium;">Jewellery </a>
                                    </li>

                                    <li class="nav-item">
                                        <a class="nav-link" href="/useraccount"
                                            style="color: black;font-size: medium;">My Account</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/logout"
                                            style="color: black;font-size: medium;">Logout</a>
                                    </li>
                                </ul>

                            </div>
                            <div class="quote_btn-container ">
                                <a href="/cart">
                                    <i class="fa fa-shopping-bag" style="color: black; padding: 20px;"></i>
                                    <div class="cart_number" style="color: black; background-color: aliceblue;">
                                        <%=cart?.length%>
                                    </div>
                                </a>
                                <a href="/wishlist">
                                    <i class="fa fa-heart" style="color: rgb(193, 8, 8); padding: 20px;"></i>
                                    <div class="wishlist_number" style="color: black; background-color: aliceblue;">

                                    </div>
                                </a>

                            </div>
                        </div>
                    </nav>

                </div>
            </header>

            <section class="mt-50 mb-50">
                <div class="cart-container">

                    <% if (!cart || cart.length===0) { %>
                        <div class="empty-cart">
                            <i class="fa fa-shopping-cart"></i>
                            <h3>Your cart is empty</h3>
                            <p>Looks like you haven't added any items to your cart yet.</p>
                            <a href="/jewellery" class="btn">Start Shopping</a>
                        </div>
                        <% } else { %>

                            <div class="cart-header">
                                <h1>Your Shopping Cart</h1>
                            </div>
                            <% if (hasOutOfStockProducts) { %>
                                <div class="alert alert-warning">
                                    Some items in your cart are currently out of stock or have insufficient quantity.
                                    Please remove or adjust the quantities before checking out.
                                </div>
                                <% } %>
                                    <div class="table-responsive">
                                        <table class="table shopping-summery text-center clean">
                                            <thead>
                                                <tr class="main-heading">
                                                    <th scope="col">Image</th>
                                                    <th scope="col">Name</th>
                                                    <th scope="col">Price</th>
                                                    <th scope="col">Quantity</th>
                                                    <th scope="col">Subtotal</th>
                                                    <th scope="col">Remove</th>
                                                </tr>
                                            </thead>
                                            <tbody>

                                                <% if (cart?.length> 0) {
                                                    cart.forEach((cartData,index)=>{
                                                    %>
                                                    <p></p>
                                                    <tr>
                                                        <td class="image product-thumbnail"><img
                                                                src="/assets/imgs/productIMG/<%=cartData.productData_id.images[0]%>"
                                                                alt="#"></td>
                                                        <td class="product-des product-name">
                                                            <%=cartData.productData_id.name%>
                                                        </td>
                                                        <td class="price" data-title="Price"><span>
                                                                ₹<%=cartData.productData_id.discount_price %>
                                                            </span></td>

                                                        <td class="text-center" data-title="Stock">
                                                            <% if (cartData.productData_id.stock===0 ){ %>
                                                                <div class="alert alert-warning"
                                                                    style="background-color: #ffdddd; color: #d8000c; border: 1px solid #d8000c; padding: 15px; border-radius: 8px;">
                                                                    Out of Stock
                                                                </div>
                                                                <%}else{%>
                                                                    <div class="cart-product-quantity">
                                                                        <button type="button" class="quantity-btn"
                                                                            onclick="decrementQuantity(this, '<%= cartData.productData_id._id %>', <%= cartData.productData_id.stock %>)">
                                                                            -
                                                                        </button>
                                                                        <input type="number" class="form-control"
                                                                            name="qty" value="<%= cartData.qty %>"
                                                                            min="1"
                                                                            max="<%= Math.min(5, cartData.productData_id.stock) %>"
                                                                            step="1" required
                                                                            onchange="validateAndUpdateCart('<%= cartData.productData_id._id %>', this.value, <%= cartData.productData_id.stock %>)">
                                                                        <button type="button" class="quantity-btn"
                                                                            onclick="incrementQuantity(this, '<%= cartData.productData_id._id %>', <%= cartData.productData_id.stock %>)">
                                                                            +
                                                                        </button>
                                                                    </div>
                                                                    <%}%>
                                                        </td>
                                                        <td class="text-center" data-title="Cart">
                                                            <span>
                                                                ₹<%=productTotal[index] %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <button type="button"
                                                                onclick="confirmRemoveCartItem('<%= cartData.productData_id._id %>');"
                                                                class="remove-btn" style="
       background: none;
       border: none;
       color: #ff4545;
       cursor: pointer;
       transition: color 0.2s;
       padding: 8px;
       font-size: 18px;
   " onmouseover="this.style.color='#ff1111'" onmouseout="this.style.color='#ff4545'">
                                                                <i class="fi-rs-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    <% }) }%>

                                            </tbody>
                                        </table>
                                    </div>



                                    <div class="cart-action text-end">
                                        <button onclick="confirmClearCart()" class="clear-cart-btn">
                                            <i class="fi-rs-trash"></i>
                                            Clear Cart
                                        </button>
                                        <a href="/jewellery" class="btn">
                                            <i class="fi-rs-shopping-bag mr-10"></i>
                                            Continue Shopping
                                        </a>
                                    </div>
                                    <div class="divider center_icon mt-50 mb-50"><i class="fi-rs-fingerprint"></i></div>
                                    <div class="row mb-50">
                                        <div class="col-lg-6 col-md-12">

                                        </div>
                                        <div class="col-lg-6 col-md-12">
                                            <div class="border p-md-4 p-30 border-radius cart-totals">
                                                <div class="heading_s1 mb-3">
                                                    <h4>Cart Totals</h4>
                                                </div>
                                                <div class="table-responsive">
                                                    <table class="table">
                                                        <tbody>
                                                            <tr>
                                                                <td class="cart_total_label">Cart Subtotal</td>
                                                                <td class="cart_total_amount"><span
                                                                        class="font-lg fw-900 text-brand">
                                                                        ₹<%=subtotalWithShipping %>
                                                                    </span></td>
                                                            </tr>
                                                            <tr>
                                                                <td class="cart_total_label">Shipping</td>
                                                                <td class="cart_total_amount"> <i
                                                                        class="ti-gift mr-5"></i> Free
                                                                    Shipping</td>
                                                            </tr>
                                                            <tr>
                                                                <td class="cart_total_label">Total</td>
                                                                <td class="cart_total_amount"><strong><span
                                                                            class="font-xl fw-900 text-brand">
                                                                            ₹<%=subtotalWithShipping %>
                                                                        </span></strong></td>
                                                            </tr>

                                                        </tbody>
                                                    </table>
                                                </div>
                                                <% if (canProceedToCheckout) { %>
                                                    <a href="/order/checkout" class="btn">
                                                        <i class="fi-rs-box-alt mr-10"></i> Proceed To CheckOut
                                                    </a>
                                                    <% } %>
                                            </div>
                                        </div>
                                    </div>
                </div>
                </div>
                <% } %>
                    </div>
            </section>
        </main>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <script>
            function validateAndUpdateCart(productId, newQuantity, stockAvailable) {
                // Convert newQuantity to number
                newQuantity = parseInt(newQuantity);

                // Check if quantity exceeds maximum limit (5)
                if (newQuantity === 5) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Quantity Limit Exceeded',
                        text: 'Maximum quantity allowed is 5 items'
                    });
                    // Reset to maximum allowed value
                    newQuantity = 5;
                    // Update input value
                    event.target.value = 5;
                    return;
                }

                // Check if quantity equals available stock
                if (newQuantity === stockAvailable) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Stock Alert',
                        text: `Only ${stockAvailable} items left in stock!`
                    });
                }
                // Check if quantity exceeds available stock
                else if (newQuantity > stockAvailable) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Insufficient Stock',
                        text: `Only ${stockAvailable} items available in stock`
                    });
                    // Reset to maximum available stock
                    newQuantity = stockAvailable;
                    // Update input value
                    event.target.value = stockAvailable;
                    return;
                }

                // If validation passes, update cart
                updateCart(productId, newQuantity);
            }
            function confirmRemoveCartItem(productId) {

                Swal.fire({
                    title: "Are you sure?",
                    text: "You won't be able to revert this!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Yes, delete it!",
                }).then((result) => {
                    if (result.isConfirmed) {
                        // User clicked "Yes," so proceed with removing the item
                        removeCartItem(productId);
                    }
                });
            }

            function removeCartItem(productId) {
                fetch(`/cart/removecartitem?productId=${productId}`, {
                    method: 'DELETE',
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            localStorage.setItem('productRemoved', 'true');
                            location.reload();
                        } else {
                            console.error('Failed to remove cart item:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error removing cart item:', error);
                    });
            }
            function decrementQuantity(btn, productId, stockAvailable) {
                const input = btn.nextElementSibling;
                let value = parseInt(input.value);
                if (value > 1) {
                    value--;
                    input.value = value;
                    validateAndUpdateCart(productId, value, stockAvailable);
                }
            }

            function incrementQuantity(btn, productId, stockAvailable) {
                const input = btn.previousElementSibling;
                let value = parseInt(input.value);
                const maxValue = Math.min(5, stockAvailable);
                if (value < maxValue) {
                    value++;
                    input.value = value;
                    validateAndUpdateCart(productId, value, stockAvailable);
                }
            }
            function updateCart(productId, newQuantity) {
                console.log("Updating cart for product:", productId, "New quantity:", newQuantity); // Debugging line
                fetch(`/cart/updatecart?productId=${productId}&quantity=${newQuantity}`, {
                    method: 'PUT',
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log("Cart updated successfully");
                        } else {
                            console.error('Failed to update cart:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error updating cart:', error);
                    });
            }
            function confirmClearCart() {
                Swal.fire({
                    title: "Clear entire cart?",
                    text: "This will remove all items from your cart. This action cannot be undone!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#dc2626",
                    cancelButtonColor: "#6b7280",
                    confirmButtonText: "Yes, clear cart",
                    cancelButtonText: "Cancel"
                }).then((result) => {
                    if (result.isConfirmed) {
                        clearCart();
                    }
                });
            }

            function clearCart() {
                fetch('/cart/clearcart', {
                    method: 'DELETE',
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: "Cart Cleared!",
                                text: "Your cart has been emptied successfully.",
                                icon: "success"
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: "Error",
                                text: "Failed to clear cart. Please try again.",
                                icon: "error"
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error clearing cart:', error);
                        Swal.fire({
                            title: "Error",
                            text: "Something went wrong. Please try again.",
                            icon: "error"
                        });
                    });
            }



        </script>